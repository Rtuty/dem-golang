{{template "base.html" .}}
{{define "content"}}
<div class="page-header">
    <h2>
        {{if .isEdit}}
            Редактировать продукцию
        {{else}}
            Добавить продукцию
        {{end}}
    </h2>
    <a href="/" class="btn btn-secondary">← Назад к списку</a>
</div>

{{if .error}}
<div class="alert alert-danger">
    {{.error}}
</div>
{{end}}

<div class="form-container">
    <form method="POST" action="{{if .formAction}}{{.formAction}}{{else}}/products{{end}}" class="product-form">
        <div class="form-group">
            <label for="article" class="form-label">Артикул*</label>
            <input 
                type="text" 
                id="article" 
                name="article" 
                class="form-control" 
                value="{{if .product}}{{.product.Article}}{{end}}" 
                required
            >
        </div>

        <div class="form-group">
            <label for="product_type_id" class="form-label">Тип продукции*</label>
            <select id="product_type_id" name="product_type_id" class="form-control" required>
                <option value="">Выберите тип продукции</option>
                {{range .productTypes}}
                <option value="{{.ID}}" 
                    {{if $.product}}{{if eq .ID $.product.ProductTypeID}}selected{{end}}{{end}}>
                    {{.Name}}
                </option>
                {{end}}
            </select>
        </div>

        <div class="form-group">
            <label for="name" class="form-label">Наименование*</label>
            <input 
                type="text" 
                id="name" 
                name="name" 
                class="form-control" 
                value="{{if .product}}{{.product.Name}}{{end}}" 
                required
            >
        </div>

        <div class="form-group">
            <label for="description" class="form-label">Описание</label>
            <textarea 
                id="description" 
                name="description" 
                class="form-control" 
                rows="3"
            >{{if .product}}{{if .product.Description}}{{.product.Description}}{{end}}{{end}}</textarea>
        </div>

        <div class="form-group">
            <label for="min_partner_price" class="form-label">Минимальная стоимость для партнера (₽)*</label>
            <input 
                type="number" 
                id="min_partner_price" 
                name="min_partner_price" 
                class="form-control" 
                value="{{if .product}}{{printf "%.2f" .product.MinPartnerPrice}}{{end}}" 
                step="0.01" 
                min="0" 
                required
            >
        </div>

        <div class="form-group">
            <label for="roll_width" class="form-label">Ширина рулона (м)</label>
            <input 
                type="number" 
                id="roll_width" 
                name="roll_width" 
                class="form-control" 
                value="{{if .product}}{{if .product.RollWidth}}{{printf "%.2f" .product.RollWidth}}{{end}}{{end}}" 
                step="0.01" 
                min="0"
            >
        </div>

        <!-- Дополнительные поля -->
        <div class="form-row">
            <div class="form-group form-group-half">
                <label for="package_length" class="form-label">Длина упаковки (см)</label>
                <input 
                    type="number" 
                    id="package_length" 
                    name="package_length" 
                    class="form-control" 
                    value="{{if .product}}{{if .product.PackageLength}}{{printf "%.2f" .product.PackageLength}}{{end}}{{end}}" 
                    step="0.01" 
                    min="0"
                >
            </div>
            <div class="form-group form-group-half">
                <label for="package_width" class="form-label">Ширина упаковки (см)</label>
                <input 
                    type="number" 
                    id="package_width" 
                    name="package_width" 
                    class="form-control" 
                    value="{{if .product}}{{if .product.PackageWidth}}{{printf "%.2f" .product.PackageWidth}}{{end}}{{end}}" 
                    step="0.01" 
                    min="0"
                >
            </div>
        </div>

        <div class="form-row">
            <div class="form-group form-group-half">
                <label for="package_height" class="form-label">Высота упаковки (см)</label>
                <input 
                    type="number" 
                    id="package_height" 
                    name="package_height" 
                    class="form-control" 
                    value="{{if .product}}{{if .product.PackageHeight}}{{printf "%.2f" .product.PackageHeight}}{{end}}{{end}}" 
                    step="0.01" 
                    min="0"
                >
            </div>
            <div class="form-group form-group-half">
                <label for="cost_price" class="form-label">Себестоимость (₽)</label>
                <input 
                    type="number" 
                    id="cost_price" 
                    name="cost_price" 
                    class="form-control" 
                    value="{{if .product}}{{if .product.CostPrice}}{{printf "%.2f" .product.CostPrice}}{{end}}{{end}}" 
                    step="0.01" 
                    min="0"
                >
            </div>
        </div>

        <div class="form-row">
            <div class="form-group form-group-half">
                <label for="production_time_hours" class="form-label">Время производства (часы)</label>
                <input 
                    type="number" 
                    id="production_time_hours" 
                    name="production_time_hours" 
                    class="form-control" 
                    value="{{if .product}}{{if .product.ProductionTimeHours}}{{printf "%.2f" .product.ProductionTimeHours}}{{end}}{{end}}" 
                    step="0.1" 
                    min="0"
                >
            </div>
            <div class="form-group form-group-half">
                <label for="workshop_number" class="form-label">Номер цеха</label>
                <input 
                    type="text" 
                    id="workshop_number" 
                    name="workshop_number" 
                    class="form-control" 
                    value="{{if .product}}{{if .product.WorkshopNumber}}{{.product.WorkshopNumber}}{{end}}{{end}}"
                >
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {{if .isEdit}}
                    Сохранить изменения
                {{else}}
                    Создать продукцию
                {{end}}
            </button>
            <a href="/" class="btn btn-secondary">Отмена</a>
        </div>
    </form>
</div>

<script>
// Валидация формы и расчеты
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.product-form');
    
    // Валидация при отправке формы
    form.addEventListener('submit', function(e) {
        const minPrice = parseFloat(document.getElementById('min_partner_price').value);
        const rollWidth = document.getElementById('roll_width').value;
        const costPrice = document.getElementById('cost_price').value;

        if (minPrice < 0) {
            e.preventDefault();
            alert('Минимальная стоимость не может быть отрицательной');
            return;
        }

        if (rollWidth && parseFloat(rollWidth) < 0) {
            e.preventDefault();
            alert('Ширина рулона не может быть отрицательной');
            return;
        }

        if (costPrice && parseFloat(costPrice) < 0) {
            e.preventDefault();
            alert('Себестоимость не может быть отрицательной');
            return;
        }

        // Проверка соотношения цен
        if (costPrice && minPrice && parseFloat(costPrice) > parseFloat(minPrice)) {
            if (!confirm('Себестоимость превышает минимальную цену для партнера. Продолжить?')) {
                e.preventDefault();
                return;
            }
        }
    });

    // Расчет объема упаковки
    function calculatePackageVolume() {
        const length = parseFloat(document.getElementById('package_length').value) || 0;
        const width = parseFloat(document.getElementById('package_width').value) || 0;
        const height = parseFloat(document.getElementById('package_height').value) || 0;
        
        if (length > 0 && width > 0 && height > 0) {
            const volume = (length * width * height) / 1000000; // перевод из см³ в м³
            console.log(`Объем упаковки: ${volume.toFixed(4)} м³`);
        }
    }

    // Привязываем расчет объема к изменению размеров упаковки
    ['package_length', 'package_width', 'package_height'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', calculatePackageVolume);
        }
    });
});
</script>
{{end}} 