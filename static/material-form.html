<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ - –ù–∞—à –¥–µ–∫–æ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 10px;
            text-align: center;
        }

        .tabs {
            display: flex;
            margin-bottom: 2rem;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 1rem;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #28a745;
            color: white;
        }

        .tab:hover {
            background: #1e7e34;
            color: white;
        }

        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40,167,69,0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }

        .btn-primary {
            background: #28a745;
            color: white;
        }

        .btn-primary:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .result {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .material-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .material-item {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .material-info h3 {
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .material-actions {
            display: flex;
            gap: 0.5rem;
        }

        .low-stock {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }

        .stock-ok {
            color: #28a745;
            font-weight: bold;
        }

        .stock-warning {
            color: #ffc107;
            font-weight: bold;
        }

        .stock-danger {
            color: #dc3545;
            font-weight: bold;
        }

        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .material-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .material-actions {
                margin-top: 1rem;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –æ–±–æ–µ–≤ "–ù–∞—à –¥–µ–∫–æ—Ä"</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('create')">–°–æ–∑–¥–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
            <button class="tab" onclick="switchTab('edit')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
            <button class="tab" onclick="switchTab('list')">–°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</button>
            <button class="tab" onclick="switchTab('test')">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API</button>
        </div>

        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
        <div id="create-section" class="form-section active">
            <div class="form-container">
                <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</h2>
                <form id="create-form">
                    <div class="form-group">
                        <label class="form-label">–ê—Ä—Ç–∏–∫—É–ª *</label>
                        <input type="text" name="article" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                        <select name="material_type_id" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ *</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è *</label>
                        <select name="measurement_unit_id" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ *</label>
                            <input type="number" name="package_quantity" class="form-control" step="0.001" min="0.001" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (‚ÇΩ) *</label>
                            <input type="number" name="cost_per_unit" class="form-control" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
                            <input type="number" name="stock_quantity" class="form-control" step="0.001" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</label>
                            <input type="number" name="min_stock_quantity" class="form-control" step="0.001" min="0" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é</label>
                        <input type="text" name="image_path" class="form-control" placeholder="/static/images/materials/example.jpg">
                    </div>

                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
                    <button type="reset" class="btn btn-secondary">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
                </form>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
        <div id="edit-section" class="form-section">
            <div class="form-container">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</h2>
                
                <div class="form-group">
                    <label class="form-label">ID –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="number" id="edit-material-id" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –º–∞—Ç–µ—Ä–∏–∞–ª–∞">
                        <button onclick="loadMaterialForEdit()" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>
                </div>

                <form id="edit-form" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">–ê—Ä—Ç–∏–∫—É–ª *</label>
                        <input type="text" name="article" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞ *</label>
                        <select name="material_type_id" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ *</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è *</label>
                        <select name="measurement_unit_id" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ *</label>
                            <input type="number" name="package_quantity" class="form-control" step="0.001" min="0.001" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (‚ÇΩ) *</label>
                            <input type="number" name="cost_per_unit" class="form-control" step="0.01" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
                            <input type="number" name="stock_quantity" class="form-control" step="0.001" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</label>
                            <input type="number" name="min_stock_quantity" class="form-control" step="0.001" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é</label>
                        <input type="text" name="image_path" class="form-control">
                    </div>

                    <button type="submit" class="btn btn-warning">–û–±–Ω–æ–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>
                    <button type="button" onclick="cancelEdit()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                </form>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
        <div id="list-section" class="form-section">
            <div class="form-container">
                <h2>–°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h2>
                <button onclick="loadMaterials()" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <div id="materials-list" class="material-list" style="margin-top: 1rem;">
                    <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API -->
        <div id="test-section" class="form-section">
            <div class="form-container">
                <h2>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h2>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button onclick="testGetMaterials()" class="btn btn-primary">GET /api/v1/materials</button>
                    <button onclick="testGetMaterialTypes()" class="btn btn-secondary">GET /api/v1/material-types</button>
                    <button onclick="testGetMeasurementUnits()" class="btn btn-secondary">GET /api/v1/measurement-units</button>
                    <button onclick="testCreateMaterial()" class="btn btn-success">POST /api/v1/materials</button>
                    <button onclick="testUpdateMaterial()" class="btn btn-warning">PUT /api/v1/materials/1</button>
                    <button onclick="testDeleteMaterial()" class="btn btn-danger">DELETE /api/v1/materials/1</button>
                </div>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="result" class="result" style="display: none;">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
            <div id="result-content"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1';
        let currentEditId = null;

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å —Ç–∞–±–æ–≤
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
            document.getElementById(tabName + '-section').classList.add('active');
            event.target.classList.add('active');
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –≤–∫–ª–∞–¥–∫–∏
            if (tabName === 'create' || tabName === 'edit') {
                loadMaterialTypes();
                loadMeasurementUnits();
            } else if (tabName === 'list') {
                loadMaterials();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        async function loadMaterialTypes() {
            try {
                const response = await fetch(`${API_BASE}/material-types`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const materialTypes = data.data || [];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±–∞ —Å–µ–ª–µ–∫—Ç–∞
                const selects = document.querySelectorAll('select[name="material_type_id"]');
                selects.forEach(select => {
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞</option>';
                    materialTypes.forEach(type => {
                        select.innerHTML += `<option value="${type.id}">${type.name}</option>`;
                    });
                });
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–∏–ø—ã –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:', error.message);
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                const selects = document.querySelectorAll('select[name="material_type_id"]');
                selects.forEach(select => {
                    select.innerHTML = `
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞</option>
                        <option value="1">–û—Å–Ω–æ–≤–∞</option>
                        <option value="2">–ü–æ–∫—Ä—ã—Ç–∏–µ</option>
                        <option value="3">–ö–ª–µ—è—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</option>
                        <option value="4">–ö—Ä–∞—Å–∏—Ç–µ–ª–∏</option>
                        <option value="5">–£–ø–∞–∫–æ–≤–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</option>
                    `;
                });
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è
        async function loadMeasurementUnits() {
            try {
                const response = await fetch(`${API_BASE}/measurement-units`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const units = data.data || [];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±–∞ —Å–µ–ª–µ–∫—Ç–∞
                const selects = document.querySelectorAll('select[name="measurement_unit_id"]');
                selects.forEach(select => {
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è</option>';
                    units.forEach(unit => {
                        select.innerHTML += `<option value="${unit.id}">${unit.name} (${unit.abbreviation})</option>`;
                    });
                });
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è:', error.message);
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                const selects = document.querySelectorAll('select[name="measurement_unit_id"]');
                selects.forEach(select => {
                    select.innerHTML = `
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑–º–µ—Ä–µ–Ω–∏—è</option>
                        <option value="1">–º–µ—Ç—Ä (–º)</option>
                        <option value="2">–∫–∏–ª–æ–≥—Ä–∞–º–º (–∫–≥)</option>
                        <option value="3">—à—Ç—É–∫–∞ (—à—Ç)</option>
                        <option value="4">–ª–∏—Ç—Ä (–ª)</option>
                        <option value="5">–∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –º–µ—Ç—Ä (–º¬≤)</option>
                        <option value="6">—Ä—É–ª–æ–Ω (—Ä—É–ª)</option>
                    `;
                });
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
            ['material_type_id', 'measurement_unit_id', 'package_quantity', 'cost_per_unit', 
             'stock_quantity', 'min_stock_quantity'].forEach(field => {
                if (data[field] && data[field] !== '') {
                    data[field] = parseFloat(data[field]);
                } else if (['material_type_id', 'measurement_unit_id', 'package_quantity', 'cost_per_unit'].includes(field)) {
                    // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –Ω–µ —É–¥–∞–ª—è–µ–º
                } else {
                    delete data[field]; // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                }
            });
            
            // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ image_path
            if (!data.description) delete data.description;
            if (!data.image_path) delete data.image_path;
            
            try {
                const response = await fetch(`${API_BASE}/materials`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('–ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! ID: ' + result.data.id, 'success');
                    e.target.reset();
                } else {
                    showResult('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showResult('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function loadMaterialForEdit() {
            const id = document.getElementById('edit-material-id').value;
            if (!id) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –º–∞—Ç–µ—Ä–∏–∞–ª–∞');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/materials/${id}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                if (result.success && result.data) {
                    fillEditForm(result.data);
                    currentEditId = id;
                    document.getElementById('edit-form').style.display = 'block';
                    showResult('–ú–∞—Ç–µ—Ä–∏–∞–ª –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'success');
                } else {
                    showResult('–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                }
            } catch (error) {
                showResult('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
            }
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function fillEditForm(material) {
            const form = document.getElementById('edit-form');
            
            form.querySelector('[name="article"]').value = material.article || '';
            form.querySelector('[name="material_type_id"]').value = material.material_type_id || '';
            form.querySelector('[name="name"]').value = material.name || '';
            form.querySelector('[name="description"]').value = material.description || '';
            form.querySelector('[name="measurement_unit_id"]').value = material.measurement_unit_id || '';
            form.querySelector('[name="package_quantity"]').value = material.package_quantity || '';
            form.querySelector('[name="cost_per_unit"]').value = material.cost_per_unit || '';
            form.querySelector('[name="stock_quantity"]').value = material.stock_quantity || '';
            form.querySelector('[name="min_stock_quantity"]').value = material.min_stock_quantity || '';
            form.querySelector('[name="image_path"]').value = material.image_path || '';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentEditId) {
                alert('–ù–µ—Ç ID –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                return;
            }
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
            ['material_type_id', 'measurement_unit_id', 'package_quantity', 'cost_per_unit', 
             'stock_quantity', 'min_stock_quantity'].forEach(field => {
                if (data[field] && data[field] !== '') {
                    data[field] = parseFloat(data[field]);
                } else if (['material_type_id', 'measurement_unit_id', 'package_quantity', 'cost_per_unit'].includes(field)) {
                    // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è, –Ω–µ —É–¥–∞–ª—è–µ–º
                } else {
                    delete data[field];
                }
            });
            
            // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ image_path
            if (!data.description) delete data.description;
            if (!data.image_path) delete data.image_path;
            
            try {
                const response = await fetch(`${API_BASE}/materials/${currentEditId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('–ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                } else {
                    showResult('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showResult('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            }
        });

        // –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function cancelEdit() {
            document.getElementById('edit-form').style.display = 'none';
            document.getElementById('edit-material-id').value = '';
            currentEditId = null;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        async function loadMaterials() {
            try {
                const response = await fetch(`${API_BASE}/materials`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                const materials = result.data || [];
                
                const listContainer = document.getElementById('materials-list');
                if (materials.length === 0) {
                    listContainer.innerHTML = '<div class="alert alert-info">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                
                listContainer.innerHTML = materials.map(material => {
                    const stockStatus = material.stock_quantity < material.min_stock_quantity ? 'stock-danger' : 'stock-ok';
                    const lowStockClass = material.stock_quantity < material.min_stock_quantity ? 'low-stock' : '';
                    
                    return `
                        <div class="material-item ${lowStockClass}">
                            <div class="material-info">
                                <h3>${material.name} (${material.article})</h3>
                                <p><strong>–¢–∏–ø:</strong> ${material.material_type ? material.material_type.name : '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${material.cost_per_unit}‚ÇΩ –∑–∞ ${material.measurement_unit ? material.measurement_unit.abbreviation : '–µ–¥.'}</p>
                                <p><strong>–û—Å—Ç–∞—Ç–æ–∫:</strong> <span class="${stockStatus}">${material.stock_quantity} / ${material.min_stock_quantity}</span></p>
                                ${material.stock_quantity < material.min_stock_quantity ? 
                                    '<p class="stock-danger"><strong>‚ö†Ô∏è –ù–∏–∑–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫!</strong></p>' : ''}
                            </div>
                            <div class="material-actions">
                                <button onclick="editMaterial(${material.id})" class="btn btn-warning">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button onclick="deleteMaterial(${material.id})" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                showResult('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞: ' + error.message, 'error');
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
        function editMaterial(id) {
            switchTab('edit');
            document.getElementById('edit-material-id').value = id;
            loadMaterialForEdit();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
        async function deleteMaterial(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/materials/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('–ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!', 'success');
                    loadMaterials(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    showResult('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showResult('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            }
        }

        // –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ API
        async function testGetMaterials() {
            await testApiCall('GET', '/materials', null, '–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤');
        }

        async function testGetMaterialTypes() {
            await testApiCall('GET', '/material-types', null, '–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤');
        }

        async function testGetMeasurementUnits() {
            await testApiCall('GET', '/measurement-units', null, '–ü–æ–ª—É—á–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è');
        }

        async function testCreateMaterial() {
            const testMaterial = {
                article: 'TEST-' + Date.now(),
                material_type_id: 1,
                name: '–¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª',
                description: '–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞',
                measurement_unit_id: 1,
                package_quantity: 10.0,
                cost_per_unit: 50.00,
                stock_quantity: 100.0,
                min_stock_quantity: 10.0
            };
            await testApiCall('POST', '/materials', testMaterial, '–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞');
        }

        async function testUpdateMaterial() {
            const testUpdate = {
                name: '–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª',
                cost_per_unit: 75.00
            };
            await testApiCall('PUT', '/materials/1', testUpdate, '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ —Å ID 1');
        }

        async function testDeleteMaterial() {
            if (confirm('–≠—Ç–æ —É–¥–∞–ª–∏—Ç –º–∞—Ç–µ—Ä–∏–∞–ª —Å ID 1. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                await testApiCall('DELETE', '/materials/1', null, '–£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ —Å ID 1');
            }
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API
        async function testApiCall(method, endpoint, data, description) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                
                showResult(
                    `<strong>${description}</strong><br>
                     <strong>–°—Ç–∞—Ç—É—Å:</strong> ${response.status}<br>
                     <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong><br>
                     <pre>${JSON.stringify(result, null, 2)}</pre>`,
                    response.ok ? 'success' : 'error'
                );
            } catch (error) {
                showResult(`<strong>${description}</strong><br>–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            const contentDiv = document.getElementById('result-content');
            
            contentDiv.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'error'}">${message}</div>`;
            resultDiv.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
            if (type === 'success') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 10000);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadMaterialTypes();
            loadMeasurementUnits();
        });
    </script>
</body>
</html> 