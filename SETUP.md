# Инструкция по настройке и запуску системы "Наш декор"

## Быстрый старт с Docker (рекомендуется)

### Предварительные требования для Docker
1. **Docker** - [Установить Docker](https://docs.docker.com/get-docker/)
2. **Docker Compose** - обычно включен в Docker Desktop

### Запуск с Docker
```bash
# Быстрый старт (очистка + запуск)
make quick-start

# Или пошагово:
make docker-run
```

Приложение будет доступно на:
- **Веб-интерфейс**: http://localhost:8080
- **База данных**: localhost:5432
- **Adminer** (опционально): http://localhost:8081

### Основные команды Makefile
```bash
make help              # Показать все доступные команды
make docker-run        # Запустить с Docker Compose
make docker-stop       # Остановить контейнеры
make docker-clean      # Очистить все Docker ресурсы
make logs              # Показать логи приложения
make db-logs           # Показать логи базы данных
make status            # Проверить состояние сервисов
```

## Локальный запуск (без Docker)

### Предварительные требования

1. **Go 1.21+** - [Установить Go](https://golang.org/dl/)
2. **PostgreSQL 13+** - [Установить PostgreSQL](https://www.postgresql.org/download/)
3. **Git** - для клонирования репозитория

### Настройка базы данных

1. Создайте базу данных PostgreSQL:
```sql
CREATE DATABASE wallpaper_system;
CREATE USER wallpaper_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE wallpaper_system TO wallpaper_user;
```

2. Настройте переменные окружения (или создайте файл `.env`):
```bash
export DB_HOST=localhost
export DB_PORT=5432
export DB_USER=wallpaper_user
export DB_PASSWORD=your_password
export DB_NAME=wallpaper_system
export DB_SSLMODE=disable

export SERVER_HOST=localhost
export SERVER_PORT=8080
```

### Установка и запуск

1. **Установите зависимости:**
```bash
go mod download
# или
make dev-setup
```

2. **Выполните миграции базы данных:**
```bash
make migrate-up
# или
go run cmd/migrate/main.go up
```

3. **Проверьте статус миграций:**
```bash
make migrate-status
# или
go run cmd/migrate/main.go status
```

4. **Запустите сервер:**
```bash
make run
# или
go run cmd/server/main.go
```

5. **Откройте браузер и перейдите по адресу:**
```
http://localhost:8080
```

## Docker архитектура

Проект состоит из следующих сервисов:

### 1. PostgreSQL (`postgres`)
- База данных приложения
- Автоматическая инициализация с тестовыми данными
- Persistent storage для данных

### 2. Миграции (`migrate`)
- Автоматическое выполнение миграций при запуске
- Запускается один раз и завершается

### 3. Веб-приложение (`app`)
- Основное приложение на Go
- Автоматический перезапуск при сбоях
- Health checks для мониторинга

### 4. Adminer (`adminer`) - опционально
- Веб-интерфейс для управления базой данных
- Запускается только с профилем `tools`
- Доступен на порту 8081

## Полезные команды

### Docker команды
```bash
# Сборка и запуск
make docker-build     # Собрать образ
make docker-run       # Запустить все сервисы
make restart          # Перезапустить приложение

# Мониторинг
make logs             # Логи приложения
make db-logs          # Логи базы данных
make status           # Состояние сервисов

# Очистка
make docker-stop      # Остановить сервисы
make docker-clean     # Полная очистка

# Работа с базой данных
make db-connect       # Подключиться к БД через psql
make db-backup        # Создать бэкап БД

# Дополнительные инструменты
make tools            # Запустить Adminer
```

### Разработка
```bash
make dev-setup        # Настроить среду разработки
make build            # Собрать локально
make test             # Запустить тесты
make lint             # Проверить код линтером
make fmt              # Форматировать код
```

## Переменные окружения

### Docker Compose (по умолчанию)
```
DB_HOST=postgres
DB_PORT=5432
DB_USER=wallpaper_user
DB_PASSWORD=wallpaper_pass
DB_NAME=wallpaper_system
DB_SSLMODE=disable
SERVER_HOST=0.0.0.0
SERVER_PORT=8080
```

### Локальная разработка
```
DB_HOST=localhost
DB_PORT=5432
DB_USER=wallpaper_user
DB_PASSWORD=your_password
DB_NAME=wallpaper_system
DB_SSLMODE=disable
SERVER_HOST=localhost
SERVER_PORT=8080
```

## Структура данных

После выполнения миграций в системе будут созданы тестовые данные:

### Типы продукции:
- Виниловые обои (коэффициент 1.2)
- Флизелиновые обои (коэффициент 1.1)
- Бумажные обои (коэффициент 1.0)
- Текстильные обои (коэффициент 1.5)
- Фотообои (коэффициент 1.3)

### Примеры продукции:
- Виниловые обои "Классик"
- Флизелиновые обои "Премиум"
- Бумажные обои "Эко"
- Виниловые обои "Люкс"
- Текстильные обои "Сатин"

### Материалы:
- Флизелиновая основа
- Бумажная основа
- Виниловое покрытие
- Акриловое покрытие
- ПВА клей
- Красители различных цветов

## Функциональность системы

### 1. Управление продукцией
- Просмотр списка продукции с расчетными стоимостями
- Детальная информация о каждом продукте
- Добавление новой продукции
- Редактирование существующей продукции
- Удаление продукции

### 2. Материалы и склад
- Просмотр списка всех материалов
- Информация о типах материалов и проценте брака
- Отслеживание остатков на складе
- Индикация низких остатков

### 3. Расчет стоимости
- Автоматический расчет стоимости продукции на основе материалов
- Учет коэффициентов типов продукции
- Отображение наценки и маржинальности

### 4. Калькулятор материалов
- Расчет необходимого количества материала для производства
- Учет процента брака материалов
- Учет коэффициентов типов продукции
- Учет остатков на складе

## API Endpoints

### Веб-интерфейс:
- `GET /` - Главная страница (список продукции)
- `GET /products` - Список продукции
- `GET /products/new` - Форма добавления продукции
- `POST /products/new` - Создание продукции
- `GET /products/:id` - Детали продукции
- `GET /products/:id/edit` - Форма редактирования
- `POST /products/:id/edit` - Обновление продукции
- `GET /products/:id/materials` - Материалы продукции
- `GET /materials` - Список материалов
- `GET /calculator` - Калькулятор материалов
- `POST /calculator` - Расчет материалов

### API:
- `GET /api/products/` - JSON список продукции
- `DELETE /api/products/:id` - Удаление продукции
- `POST /api/calculator/` - Расчет материалов (JSON)

## Администрирование

### Миграции:
```bash
# Выполнить все миграции
go run cmd/migrate/main.go up

# Откатить последнюю миграцию
go run cmd/migrate/main.go down

# Показать статус миграций
go run cmd/migrate/main.go status
```

### Переменные окружения:
- `DB_HOST` - хост базы данных (по умолчанию: localhost)
- `DB_PORT` - порт базы данных (по умолчанию: 5432)
- `DB_USER` - пользователь базы данных (по умолчанию: postgres)
- `DB_PASSWORD` - пароль базы данных (по умолчанию: postgres)
- `DB_NAME` - имя базы данных (по умолчанию: wallpaper_system)
- `DB_SSLMODE` - режим SSL (по умолчанию: disable)
- `SERVER_HOST` - хост сервера (по умолчанию: localhost)
- `SERVER_PORT` - порт сервера (по умолчанию: 8080)

## Решение проблем

### Ошибка подключения к базе данных:
1. Убедитесь, что PostgreSQL запущен
2. Проверьте правильность настроек подключения
3. Убедитесь, что база данных и пользователь созданы

### Ошибки миграций:
1. Убедитесь, что база данных доступна
2. Проверьте права пользователя на создание таблиц
3. Убедитесь, что миграции выполняются в правильном порядке

### Проблемы с веб-интерфейсом:
1. Проверьте, что сервер запущен и доступен
2. Убедитесь, что статические файлы (CSS/JS) загружаются
3. Проверьте консоль браузера на наличие ошибок JavaScript

## Разработка

### Структура проекта:
```
├── cmd/                    # Точки входа приложения
│   ├── server/            # Веб-сервер
│   └── migrate/           # Утилита миграций
├── internal/              # Внутренняя логика
│   ├── config/           # Конфигурация
│   ├── database/         # Подключение к БД
│   ├── models/           # Модели данных
│   ├── repository/       # Репозитории (доступ к данным)
│   ├── services/         # Бизнес-логика
│   └── handlers/         # HTTP обработчики
├── migrations/           # Миграции базы данных
├── templates/           # HTML шаблоны
└── static/             # Статические файлы (CSS, JS, изображения)
```

### Добавление новых функций:
1. Создайте миграцию для изменений в базе данных
2. Обновите модели данных в `internal/models/`
3. Добавьте методы в репозитории `internal/repository/`
4. Реализуйте бизнес-логику в сервисах `internal/services/`
5. Создайте HTTP обработчики в `internal/handlers/`
6. Добавьте маршруты в `cmd/server/main.go`
7. Создайте или обновите HTML шаблоны

## Контакты

Если у вас возникли вопросы или проблемы, обратитесь к разработчику системы. 